# Documentation for Out-of-Hours Admin Login Detection Rule

## Overview
This rule is designed to detect successful login attempts by administrator accounts outside of regular hours. It helps in identifying potential unauthorised access or unusual activities that could indicate security incidents.

## Rule Details

### Metadata
- **Author**: MO
- **Description**: Detects out-of-hours successful authentication for admin accounts.
- **Severity**: MEDIUM

### Events
The rule triggers on the following conditions:
1. **Event Type**: 
   - The event must be a user login:  
     `$out_of_hours_login.metadata.event_type = "USER_LOGIN"`

2. **User Email**: 
   - The email address of the user attempting to log in:  
     `$out_of_hours_login.target.user.email_addresses = $user`

3. **Action**: 
   - The action must be allowed:  
     `$out_of_hours_login.security_result.action = "ALLOW"`

4. **User Role**: 
   - The user must be an administrator:  
     `$out_of_hours_login.target.user.user_role = "ADMINISTRATOR" 
     or
     $out_of_hours_login.target.user.attribute.roles.type = "ADMINISTRATOR"
     `

5. **Timestamp**: 
   - The timestamp of the event is stored for further analysis:  
     `$ts = $out_of_hours_login.metadata.event_timestamp.seconds`

### Time Conditions
The following conditions determine if the login is out of hours:
- **Weekend Activity**: 
  - The login occurs on Saturday (01) or Sunday (07):  
    `(01 = timestamp.get_day_of_week($ts, "UTC") or 07 = timestamp.get_day_of_week($ts, "UTC"))`

- **After-Hours Activity**: 
  - The login occurs between 19:00 and 07:00:  
    `(timestamp.get_hour($ts, "UTC") >= 0 and timestamp.get_hour($ts, "UTC") < 7) or timestamp.get_hour($ts, "UTC") > 19`

### Outcome
The rule evaluates the following outcomes based on the time conditions:
- **Weekend Activity Score**:
  - Assigns a score of 75 for Saturday and 70 for Sunday:  
    `$weekend_activity = max(
        if (01 = timestamp.get_day_of_week($ts, "UTC"), 75) +
        if (07 = timestamp.get_day_of_week($ts, "UTC"), 70)
    )`

- **After-Hours Activity Score**:
  - Assigns a score of 50 for logins occurring after hours:  
    `$after_hours_activity = max(
        if ((timestamp.get_hour($ts, "UTC") >= 0 and timestamp.get_hour($ts, "UTC") < 7) or
        timestamp.get_hour($ts, "UTC") > 19, 50)
    )`

### Condition
The rule is triggered if all specified conditions are met:  
`$out_of_hours_login`

## How to Use
1. **Deployment**: Integrate this rule into your security monitoring system that supports custom detection rules.
2. **Monitoring**: Regularly review alerts generated by this rule for potential unauthorised access attempts.
3. **Adjustment**: Consider adjusting the severity and conditions based on your organisationâ€™s specific risk profile and operational hours.

## Customisation
- **Time Range**: Modify the hours defined in the after-hours condition to align with your organisation's operational hours.
- **User Roles**: Adjust the user role conditions to include or exclude specific roles based on your security policies.

## Notes
- Ensure that the rule is tested in a safe environment before deployment to avoid false positives.
- This rule should be part of a broader security strategy that includes user training and incident response protocols.

## License
This rule is provided under the MIT License. See the root LICENSE file for details.
